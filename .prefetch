#! /usr/bin/env bash
set -x
pushd $(dirname $0) > /dev/null
buildpack_dir=$(pwd)
popd > /dev/null

magic_curl_url="https://github.com/ryanbrainard/magic-curl/archive/master.tar.gz"
magic_curl_home="$buildpack_dir/opt/magic_curl"
export MAGIC_CURL_CACHE="$magic_curl_home/cache"

if [ ! -d $magic_curl_home ]; then
  mkdir -p $magic_curl_home
  curl --fail --silent --location $magic_curl_url | tar xz -C $magic_curl_home --strip-components=1
fi

prefetch() {
  $magic_curl_home/bin/curl $1 --fail --location --silent > /dev/null
}

prefetch "http://heroku-jvm-common.s3.amazonaws.com/jvm-buildpack-common.tar.gz"
prefetch "http://s3.amazonaws.com/heroku-jvm-langpack-java/maven.tar.gz"
prefetch "https://s3.amazonaws.com/heroku-jdk/openjdk1.6.0_27.tar.gz"
prefetch "https://heroku-jdk.s3.amazonaws.com/openjdk1.7.0_21.tar.gz"

mv $buildpack_dir/bin/compile $buildpack_dir/bin/compile0
cat > $buildpack_dir/bin/compile <<EOF
#! /usr/bin/env sh
pushd \$(dirname \$0) > /dev/null
buildpack_dir=\$(pwd)
popd > /dev/null
export MAGIC_CURL_CACHE="\$buildpack_dir/opt/magic_curl/cache"
export PATH=\$buildpack_dir/opt/magic_curl/bin:\$PATH
exec bin/compile0
EOF
chmod +x $buildpack_dir/bin/compile
